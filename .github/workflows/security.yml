name: ğŸ”’ Security Scanning

# Trigger del pipeline
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 1' # Cada lunes a las 2 AM
  workflow_dispatch:

jobs:
  # ========================================
  # ğŸ” ANÃLISIS DE VULNERABILIDADES BACKEND
  # ========================================
  backend-security:
    name: ğŸ”’ Security Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Instalar dependencias
        run: |
          cd backend
          pip install -r requirements.txt
          pip install safety bandit semgrep
      
      - name: ğŸ” AnÃ¡lisis de vulnerabilidades con Safety
        run: |
          cd backend
          safety check --json --output safety-report.json || true
          safety check --short-report
      
      - name: ğŸ”’ AnÃ¡lisis de seguridad con Bandit
        run: |
          cd backend
          bandit -r app/ -f json -o bandit-report.json || true
          bandit -r app/ -ll
      
      - name: ğŸ” AnÃ¡lisis estÃ¡tico con Semgrep
        run: |
          cd backend
          semgrep --config=auto app/ --json --output=semgrep-report.json || true
          semgrep --config=auto app/
      
      - name: ğŸ“Š Subir reportes de seguridad
        uses: actions/upload-artifact@v3
        with:
          name: backend-security-reports
          path: |
            backend/safety-report.json
            backend/bandit-report.json
            backend/semgrep-report.json

  # ========================================
  # ğŸ” ANÃLISIS DE VULNERABILIDADES FRONTEND
  # ========================================
  frontend-security:
    name: ğŸ”’ Security Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: ğŸ“¦ Instalar dependencias
        run: |
          cd frontend
          npm ci
      
      - name: ğŸ” AnÃ¡lisis de vulnerabilidades con npm audit
        run: |
          cd frontend
          npm audit --json > npm-audit-report.json || true
          npm audit
      
      - name: ğŸ”’ AnÃ¡lisis de seguridad con Snyk
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
      
      - name: ğŸ“Š Subir reportes de seguridad frontend
        uses: actions/upload-artifact@v3
        with:
          name: frontend-security-reports
          path: frontend/npm-audit-report.json

  # ========================================
  # ğŸ” ANÃLISIS DE SECRETOS
  # ========================================
  secrets-scan:
    name: ğŸ” Secrets Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ” Detectar secretos con TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified
      
      - name: ğŸ” Detectar secretos con GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ========================================
  # ğŸ” ANÃLISIS DE DEPENDENCIAS
  # ========================================
  dependency-review:
    name: ğŸ” Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ” Revisar dependencias
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: moderate
          allow-licenses: MIT, Apache-2.0, BSD-3-Clause, ISC
          deny-licenses: GPL-2.0, GPL-3.0

  # ========================================
  # ğŸ“Š REPORTE DE SEGURIDAD
  # ========================================
  security-report:
    name: ğŸ“Š Security Report
    runs-on: ubuntu-latest
    needs: [backend-security, frontend-security, secrets-scan]
    if: always()
    
    steps:
      - name: ğŸ“¥ Descargar reportes
        uses: actions/download-artifact@v3
        with:
          path: security-reports
      
      - name: ğŸ“Š Generar reporte consolidado
        run: |
          echo "# ğŸ”’ Security Report" > security-summary.md
          echo "Fecha: $(date)" >> security-summary.md
          echo "" >> security-summary.md
          
          echo "## Backend Security" >> security-summary.md
          if [ -f "security-reports/backend-security-reports/safety-report.json" ]; then
            echo "âœ… Safety scan completado" >> security-summary.md
          fi
          if [ -f "security-reports/backend-security-reports/bandit-report.json" ]; then
            echo "âœ… Bandit scan completado" >> security-summary.md
          fi
          if [ -f "security-reports/backend-security-reports/semgrep-report.json" ]; then
            echo "âœ… Semgrep scan completado" >> security-summary.md
          fi
          
          echo "" >> security-summary.md
          echo "## Frontend Security" >> security-summary.md
          if [ -f "security-reports/frontend-security-reports/npm-audit-report.json" ]; then
            echo "âœ… NPM audit completado" >> security-summary.md
          fi
          
          echo "" >> security-summary.md
          echo "## Secrets Scan" >> security-summary.md
          echo "âœ… TruffleHog scan completado" >> security-summary.md
          echo "âœ… GitLeaks scan completado" >> security-summary.md
          
          cat security-summary.md
      
      - name: ğŸ“Š Subir reporte consolidado
        uses: actions/upload-artifact@v3
        with:
          name: security-summary
          path: security-summary.md
      
      - name: ğŸ“± Notificar si hay vulnerabilidades crÃ­ticas
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            ğŸš¨ *Vulnerabilidades de Seguridad Detectadas*
            ğŸ”’ Sistema de PrÃ©stamos y Cobranza
            ğŸ“Š Branch: ${{ github.ref_name }}
            ğŸ‘¤ Usuario: ${{ github.actor }}
            ğŸ”— Ver detalles: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
