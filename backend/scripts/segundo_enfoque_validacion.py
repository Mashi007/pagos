#!/usr/bin/env python3
"""
SEGUNDO ENFOQUE DE VALIDACI√ìN - AN√ÅLISIS PROFUNDO DE ERRORES
Verificaci√≥n exhaustiva de errores y posibles causas despu√©s de correcciones
"""

import requests
import os
import logging
import time
import subprocess
import json
from dotenv import load_dotenv
from datetime import datetime

load_dotenv()

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

BASE_URL = os.getenv("FRONTEND_URL", "https://pagos-f2qf.onrender.com")

def enfoque_1_verificacion_sintaxis_codigo():
    """ENFOQUE 1: Verificaci√≥n exhaustiva de sintaxis en c√≥digo cr√≠tico"""
    logger.info("")
    logger.info("üîç ENFOQUE 1: VERIFICACI√ìN DE SINTAXIS EN C√ìDIGO CR√çTICO")
    logger.info("=" * 70)
    logger.info("üìã Objetivo: Verificar que no hay errores de sintaxis en archivos cr√≠ticos")
    
    archivos_criticos = [
        "backend/app/api/v1/endpoints/auth.py",
        "backend/app/api/v1/endpoints/users.py", 
        "backend/app/api/v1/endpoints/analistas.py",
        "backend/app/core/security_audit.py",
        "backend/app/utils/auditoria_helper.py",
        "backend/app/schemas/user.py",
        "backend/app/models/user.py",
        "backend/app/main.py"
    ]
    
    errores_encontrados = []
    
    for archivo in archivos_criticos:
        logger.info(f"üìÑ Verificando: {archivo}")
        try:
            # Verificar sintaxis Python
            result = subprocess.run([
                "python", "-m", "py_compile", archivo
            ], capture_output=True, text=True, timeout=30)
            
            if result.returncode == 0:
                logger.info(f"   ‚úÖ Sintaxis correcta")
            else:
                logger.error(f"   ‚ùå Error de sintaxis:")
                logger.error(f"      {result.stderr}")
                errores_encontrados.append((archivo, result.stderr))
                
        except Exception as e:
            logger.error(f"   ‚ùå Error verificando archivo: {e}")
            errores_encontrados.append((archivo, str(e)))
    
    logger.info("")
    logger.info("üìä RESUMEN ENFOQUE 1:")
    logger.info("-" * 40)
    if errores_encontrados:
        logger.error(f"‚ùå Errores encontrados: {len(errores_encontrados)}")
        for archivo, error in errores_encontrados:
            logger.error(f"   üìÑ {archivo}: {error}")
    else:
        logger.info("‚úÖ Todos los archivos cr√≠ticos tienen sintaxis correcta")
    
    return len(errores_encontrados) == 0

def enfoque_2_verificacion_imports_dependencias():
    """ENFOQUE 2: Verificaci√≥n de imports y dependencias"""
    logger.info("")
    logger.info("üîç ENFOQUE 2: VERIFICACI√ìN DE IMPORTS Y DEPENDENCIAS")
    logger.info("=" * 70)
    logger.info("üìã Objetivo: Verificar que todos los imports est√°n correctos")
    
    # Verificar imports cr√≠ticos
    imports_criticos = [
        ("backend/app/api/v1/endpoints/auth.py", ["import logging", "logger = logging.getLogger"]),
        ("backend/app/core/security_audit.py", ["import logging", "security_audit_logger = logging.getLogger"]),
        ("backend/app/utils/auditoria_helper.py", ["import logging", "logger = logging.getLogger"]),
        ("backend/app/schemas/user.py", ["from pydantic import", "field_validator"]),
        ("backend/app/api/v1/endpoints/users.py", ["import logging", "logger = logging.getLogger"])
    ]
    
    problemas_encontrados = []
    
    for archivo, imports_requeridos in imports_criticos:
        logger.info(f"üìÑ Verificando imports en: {archivo}")
        try:
            with open(archivo, 'r', encoding='utf-8') as f:
                contenido = f.read()
            
            imports_faltantes = []
            for import_req in imports_requeridos:
                if import_req not in contenido:
                    imports_faltantes.append(import_req)
            
            if imports_faltantes:
                logger.error(f"   ‚ùå Imports faltantes: {imports_faltantes}")
                problemas_encontrados.append((archivo, imports_faltantes))
            else:
                logger.info(f"   ‚úÖ Todos los imports presentes")
                
        except Exception as e:
            logger.error(f"   ‚ùå Error leyendo archivo: {e}")
            problemas_encontrados.append((archivo, [str(e)]))
    
    logger.info("")
    logger.info("üìä RESUMEN ENFOQUE 2:")
    logger.info("-" * 40)
    if problemas_encontrados:
        logger.error(f"‚ùå Problemas encontrados: {len(problemas_encontrados)}")
        for archivo, problemas in problemas_encontrados:
            logger.error(f"   üìÑ {archivo}: {problemas}")
    else:
        logger.info("‚úÖ Todos los imports est√°n correctos")
    
    return len(problemas_encontrados) == 0

def enfoque_3_verificacion_conectividad_servidor():
    """ENFOQUE 3: Verificaci√≥n exhaustiva de conectividad del servidor"""
    logger.info("")
    logger.info("üîç ENFOQUE 3: VERIFICACI√ìN DE CONECTIVIDAD DEL SERVIDOR")
    logger.info("=" * 70)
    logger.info("üìã Objetivo: Verificar estado completo del servidor")
    
    endpoints_criticos = [
        ("/", "GET", "Servidor principal"),
        ("/api/v1/auth/login", "OPTIONS", "CORS Login"),
        ("/api/v1/auth/me", "OPTIONS", "CORS Me"),
        ("/api/v1/usuarios/", "OPTIONS", "CORS Usuarios"),
        ("/api/v1/analistas/", "OPTIONS", "CORS Analistas"),
        ("/docs", "GET", "Documentaci√≥n API")
    ]
    
    problemas_conectividad = []
    
    for endpoint, metodo, descripcion in endpoints_criticos:
        logger.info(f"üåê Verificando: {descripcion} ({metodo} {endpoint})")
        try:
            if metodo == "GET":
                response = requests.get(f"{BASE_URL}{endpoint}", timeout=10)
            elif metodo == "OPTIONS":
                response = requests.options(f"{BASE_URL}{endpoint}", timeout=10)
            
            logger.info(f"   üìä Status Code: {response.status_code}")
            
            if response.status_code in [200, 405]:  # 405 es normal para algunos endpoints
                logger.info(f"   ‚úÖ {descripcion} disponible")
            else:
                logger.warning(f"   ‚ö†Ô∏è {descripcion} responde con c√≥digo inesperado: {response.status_code}")
                problemas_conectividad.append((endpoint, response.status_code))
                
        except requests.exceptions.Timeout:
            logger.error(f"   ‚ùå Timeout en {descripcion}")
            problemas_conectividad.append((endpoint, "TIMEOUT"))
        except requests.exceptions.ConnectionError:
            logger.error(f"   ‚ùå Error de conexi√≥n en {descripcion}")
            problemas_conectividad.append((endpoint, "CONNECTION_ERROR"))
        except Exception as e:
            logger.error(f"   ‚ùå Error inesperado en {descripcion}: {e}")
            problemas_conectividad.append((endpoint, str(e)))
    
    logger.info("")
    logger.info("üìä RESUMEN ENFOQUE 3:")
    logger.info("-" * 40)
    if problemas_conectividad:
        logger.error(f"‚ùå Problemas de conectividad: {len(problemas_conectividad)}")
        for endpoint, problema in problemas_conectividad:
            logger.error(f"   üåê {endpoint}: {problema}")
    else:
        logger.info("‚úÖ Todos los endpoints est√°n disponibles")
    
    return len(problemas_conectividad) == 0

def enfoque_4_verificacion_autenticacion_detallada():
    """ENFOQUE 4: Verificaci√≥n detallada del sistema de autenticaci√≥n"""
    logger.info("")
    logger.info("üîç ENFOQUE 4: VERIFICACI√ìN DETALLADA DE AUTENTICACI√ìN")
    logger.info("=" * 70)
    logger.info("üìã Objetivo: Verificar funcionamiento completo del sistema de auth")
    
    # Credenciales de prueba
    credenciales_admin = {
        "email": "itmaster@rapicreditca.com",
        "password": "admin123",
        "remember": True
    }
    
    credenciales_usuario = {
        "email": "prueba2@gmail.com", 
        "password": "Casa1803",
        "remember": True
    }
    
    problemas_auth = []
    
    # Probar login admin
    logger.info("üîë Probando login de administrador...")
    try:
        response = requests.post(f"{BASE_URL}/api/v1/auth/login", json=credenciales_admin, timeout=15)
        logger.info(f"   üìä Status Code: {response.status_code}")
        
        if response.status_code == 200:
            data = response.json()
            logger.info(f"   ‚úÖ Login admin exitoso")
            logger.info(f"   üìä Usuario: {data['user']['email']}")
            logger.info(f"   üìä Rol: {'Admin' if data['user']['is_admin'] else 'Usuario'}")
            
            # Probar endpoint /me con token
            token = data['access_token']
            headers = {"Authorization": f"Bearer {token}"}
            
            logger.info("üîç Probando endpoint /me...")
            me_response = requests.get(f"{BASE_URL}/api/v1/auth/me", headers=headers, timeout=10)
            logger.info(f"   üìä Status Code: {me_response.status_code}")
            
            if me_response.status_code == 200:
                logger.info("   ‚úÖ Endpoint /me funcionando")
            else:
                logger.error(f"   ‚ùå Error en /me: {me_response.status_code}")
                problemas_auth.append(("/me", me_response.status_code))
                
        else:
            logger.error(f"   ‚ùå Error en login admin: {response.status_code}")
            logger.error(f"   üìä Respuesta: {response.text}")
            problemas_auth.append(("login_admin", response.status_code))
            
    except Exception as e:
        logger.error(f"   ‚ùå Error en login admin: {e}")
        problemas_auth.append(("login_admin", str(e)))
    
    # Probar login usuario regular
    logger.info("")
    logger.info("üë§ Probando login de usuario regular...")
    try:
        response = requests.post(f"{BASE_URL}/api/v1/auth/login", json=credenciales_usuario, timeout=15)
        logger.info(f"   üìä Status Code: {response.status_code}")
        
        if response.status_code == 200:
            data = response.json()
            logger.info(f"   ‚úÖ Login usuario exitoso")
            logger.info(f"   üìä Usuario: {data['user']['email']}")
            logger.info(f"   üìä Rol: {'Admin' if data['user']['is_admin'] else 'Usuario'}")
        else:
            logger.error(f"   ‚ùå Error en login usuario: {response.status_code}")
            logger.error(f"   üìä Respuesta: {response.text}")
            problemas_auth.append(("login_usuario", response.status_code))
            
    except Exception as e:
        logger.error(f"   ‚ùå Error en login usuario: {e}")
        problemas_auth.append(("login_usuario", str(e)))
    
    logger.info("")
    logger.info("üìä RESUMEN ENFOQUE 4:")
    logger.info("-" * 40)
    if problemas_auth:
        logger.error(f"‚ùå Problemas de autenticaci√≥n: {len(problemas_auth)}")
        for endpoint, problema in problemas_auth:
            logger.error(f"   üîê {endpoint}: {problema}")
    else:
        logger.info("‚úÖ Sistema de autenticaci√≥n funcionando correctamente")
    
    return len(problemas_auth) == 0

def enfoque_5_verificacion_endpoints_criticos():
    """ENFOQUE 5: Verificaci√≥n de endpoints cr√≠ticos con autenticaci√≥n"""
    logger.info("")
    logger.info("üîç ENFOQUE 5: VERIFICACI√ìN DE ENDPOINTS CR√çTICOS")
    logger.info("=" * 70)
    logger.info("üìã Objetivo: Verificar endpoints cr√≠ticos con autenticaci√≥n")
    
    # Primero obtener token de admin
    logger.info("üîë Obteniendo token de administrador...")
    try:
        response = requests.post(f"{BASE_URL}/api/v1/auth/login", 
                               json={"email": "itmaster@rapicreditca.com", "password": "admin123", "remember": True}, 
                               timeout=15)
        
        if response.status_code != 200:
            logger.error("‚ùå No se pudo obtener token de admin")
            return False
            
        token = response.json()['access_token']
        headers = {"Authorization": f"Bearer {token}"}
        logger.info("‚úÖ Token de administrador obtenido")
        
    except Exception as e:
        logger.error(f"‚ùå Error obteniendo token: {e}")
        return False
    
    # Endpoints cr√≠ticos a verificar
    endpoints_criticos = [
        ("/api/v1/usuarios/?page=1&page_size=10", "Lista de usuarios"),
        ("/api/v1/analistas/", "Lista de analistas"),
        ("/api/v1/clientes/?page=1&page_size=10", "Lista de clientes"),
        ("/api/v1/prestamos/?page=1&page_size=10", "Lista de pr√©stamos"),
        ("/api/v1/pagos/?page=1&page_size=10", "Lista de pagos")
    ]
    
    problemas_endpoints = []
    
    for endpoint, descripcion in endpoints_criticos:
        logger.info(f"üîó Verificando: {descripcion}")
        try:
            response = requests.get(f"{BASE_URL}{endpoint}", headers=headers, timeout=15)
            logger.info(f"   üìä Status Code: {response.status_code}")
            
            if response.status_code == 200:
                data = response.json()
                total = data.get('total', len(data.get('items', [])))
                logger.info(f"   ‚úÖ {descripcion} funcionando")
                logger.info(f"   üìä Total registros: {total}")
            else:
                logger.error(f"   ‚ùå Error en {descripcion}: {response.status_code}")
                logger.error(f"   üìä Respuesta: {response.text}")
                problemas_endpoints.append((endpoint, response.status_code))
                
        except Exception as e:
            logger.error(f"   ‚ùå Error en {descripcion}: {e}")
            problemas_endpoints.append((endpoint, str(e)))
    
    logger.info("")
    logger.info("üìä RESUMEN ENFOQUE 5:")
    logger.info("-" * 40)
    if problemas_endpoints:
        logger.error(f"‚ùå Problemas en endpoints: {len(problemas_endpoints)}")
        for endpoint, problema in problemas_endpoints:
            logger.error(f"   üîó {endpoint}: {problema}")
    else:
        logger.info("‚úÖ Todos los endpoints cr√≠ticos funcionando")
    
    return len(problemas_endpoints) == 0

def enfoque_6_verificacion_logs_errores():
    """ENFOQUE 6: Verificaci√≥n de logs y errores en tiempo real"""
    logger.info("")
    logger.info("üîç ENFOQUE 6: VERIFICACI√ìN DE LOGS Y ERRORES")
    logger.info("=" * 70)
    logger.info("üìã Objetivo: Detectar errores en logs despu√©s de las correcciones")
    
    # Realizar operaciones que generen logs
    operaciones_log = [
        ("login_admin", lambda: requests.post(f"{BASE_URL}/api/v1/auth/login", 
                                           json={"email": "itmaster@rapicreditca.com", "password": "admin123", "remember": True})),
        ("login_fail", lambda: requests.post(f"{BASE_URL}/api/v1/auth/login", 
                                           json={"email": "test@test.com", "password": "wrong", "remember": True})),
        ("endpoint_test", lambda: requests.get(f"{BASE_URL}/api/v1/usuarios/?page=1&page_size=5"))
    ]
    
    errores_detectados = []
    
    for nombre_op, operacion in operaciones_log:
        logger.info(f"üìù Ejecutando operaci√≥n: {nombre_op}")
        try:
            response = operacion()
            logger.info(f"   üìä Status Code: {response.status_code}")
            
            # Verificar si la respuesta contiene errores de logger
            if "logger" in response.text.lower() and "not defined" in response.text.lower():
                logger.error(f"   ‚ùå Error de logger detectado en respuesta")
                errores_detectados.append((nombre_op, "LOGGER_ERROR"))
            else:
                logger.info(f"   ‚úÖ Operaci√≥n ejecutada sin errores de logger")
                
        except Exception as e:
            logger.error(f"   ‚ùå Error en operaci√≥n: {e}")
            errores_detectados.append((nombre_op, str(e)))
    
    logger.info("")
    logger.info("üìä RESUMEN ENFOQUE 6:")
    logger.info("-" * 40)
    if errores_detectados:
        logger.error(f"‚ùå Errores detectados: {len(errores_detectados)}")
        for operacion, error in errores_detectados:
            logger.error(f"   üìù {operacion}: {error}")
    else:
        logger.info("‚úÖ No se detectaron errores de logger en las operaciones")
    
    return len(errores_detectados) == 0

def main():
    logger.info("üîç SEGUNDO ENFOQUE DE VALIDACI√ìN - AN√ÅLISIS PROFUNDO")
    logger.info("=" * 80)
    logger.info(f"üìä Fecha y hora: {datetime.now()}")
    logger.info("üéØ Objetivo: Verificaci√≥n exhaustiva de errores y posibles causas")
    logger.info("üîß Contexto: Despu√©s de correcciones de logger")
    logger.info("=" * 80)
    
    # Ejecutar todos los enfoques
    resultados = {}
    
    resultados["Sintaxis"] = enfoque_1_verificacion_sintaxis_codigo()
    resultados["Imports"] = enfoque_2_verificacion_imports_dependencias()
    resultados["Conectividad"] = enfoque_3_verificacion_conectividad_servidor()
    resultados["Autenticaci√≥n"] = enfoque_4_verificacion_autenticacion_detallada()
    resultados["Endpoints"] = enfoque_5_verificacion_endpoints_criticos()
    resultados["Logs"] = enfoque_6_verificacion_logs_errores()
    
    # Resumen final
    logger.info("")
    logger.info("üìä RESUMEN FINAL DEL SEGUNDO ENFOQUE")
    logger.info("=" * 80)
    
    exitosos = sum(resultados.values())
    total = len(resultados)
    
    logger.info(f"üéØ Enfoques ejecutados: {total}")
    logger.info(f"‚úÖ Enfoques exitosos: {exitosos}")
    logger.info(f"‚ùå Enfoques con problemas: {total - exitosos}")
    logger.info(f"üìà Tasa de √©xito: {(exitosos/total)*100:.1f}%")
    logger.info("")
    
    logger.info("üìã DETALLE DE RESULTADOS:")
    logger.info("-" * 50)
    for enfoque, resultado in resultados.items():
        estado = "‚úÖ EXITOSO" if resultado else "‚ùå CON PROBLEMAS"
        logger.info(f"   {enfoque}: {estado}")
    
    logger.info("")
    if exitosos == total:
        logger.info("üéâ SEGUNDO ENFOQUE COMPLETAMENTE EXITOSO")
        logger.info("   ‚úÖ Todos los sistemas verificados correctamente")
        logger.info("   ‚úÖ No se detectaron errores cr√≠ticos")
        logger.info("   ‚úÖ Sistema listo para casos reales")
    else:
        logger.error("‚ùå SEGUNDO ENFOQUE DETECT√ì PROBLEMAS")
        logger.error("   üí° Revisar resultados espec√≠ficos para identificar causas")
        logger.error("   üí° Aplicar correcciones adicionales seg√∫n sea necesario")

if __name__ == "__main__":
    main()
